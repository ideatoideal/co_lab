# 修仙游戏项目代码结构描述

## 概述
本文档描述修仙游戏项目的完整代码结构，涵盖大地图系统、战斗系统、小游戏系统等所有功能模块。采用模块化设计，确保各模块独立开发、易于维护和快速定位修改。

## 完整项目结构
```
project/
├── scenes/                          # 场景文件目录
│   ├── main/                        # 主场景
│   │   ├── Main.tscn               # 主游戏场景
│   │   └── GameManager.tscn        # 游戏管理器场景
│   ├── maps/                        # 地图系统
│   │   ├── WorldMap.tscn           # 大地图场景
│   │   ├── CityMap.tscn            # 城市地图
│   │   └── DungeonMap.tscn         # 副本地图
│   ├── characters/                  # 角色系统
│   │   ├── Player.tscn             # 玩家角色
│   │   ├── NPC.tscn                # NPC基础场景
│   │   └── Enemy.tscn              # 敌人场景
│   ├── battle/                      # 战斗系统
│   │   ├── BattleScene.tscn        # 战斗场景
│   │   ├── BattleUI.tscn           # 战斗界面
│   │   └── SkillEffect.tscn        # 技能效果
│   ├── cultivation/                 # 修炼系统
│   │   ├── CultivationUI.tscn      # 修炼界面
│   │   └── RealmBreakthrough.tscn  # 突破场景
│   ├── minigames/                   # 小游戏系统
│   │   ├── AlchemyGame.tscn        # 炼丹小游戏
│   │   ├── FishingGame.tscn        # 钓鱼小游戏
│   │   └── PuzzleGame.tscn         # 解谜小游戏
│   ├── ui/                          # 用户界面
│   │   ├── MainMenu.tscn           # 主菜单
│   │   ├── Inventory.tscn          # 背包界面
│   │   ├── ShopUI.tscn             # 商店界面
│   │   └── DialogueUI.tscn         # 对话界面
│   └── effects/                     # 特效场景
│       ├── Particles.tscn          # 粒子特效
│       └── ScreenEffects.tscn      # 屏幕特效
├── scripts/                         # 脚本文件目录
│   ├── core/                        # 核心系统
│   │   ├── GameManager.cs          # 游戏管理器
│   │   ├── SaveManager.cs          # 存档管理
│   │   ├── AudioManager.cs         # 音频管理
│   │   └── EventBus.cs             # 事件总线
│   ├── characters/                  # 角色脚本
│   │   ├── Player.cs               # 玩家控制
│   │   ├── PlayerStats.cs          # 玩家属性
│   │   ├── NPCController.cs        # NPC控制器
│   │   └── EnemyAI.cs              # 敌人AI
│   ├── maps/                        # 地图脚本
│   │   ├── WorldMapController.cs   # 大地图控制
│   │   ├── MapGenerator.cs         # 地图生成器
│   │   └── TeleportPoint.cs        # 传送点
│   ├── battle/                      # 战斗脚本
│   │   ├── BattleSystem.cs         # 战斗系统核心
│   │   ├── Skill.cs                # 技能基类
│   │   ├── CombatCalculator.cs     # 战斗计算
│   │   └── TurnManager.cs          # 回合管理
│   ├── cultivation/                 # 修炼脚本
│   │   ├── CultivationManager.cs   # 修炼管理器
│   │   ├── Realm.cs                # 境界系统
│   │   └── Technique.cs            # 功法系统
│   ├── items/                       # 物品脚本
│   │   ├── Item.cs                 # 物品基类
│   │   ├── Equipment.cs            # 装备类
│   │   ├── Consumable.cs           # 消耗品类
│   │   └── Inventory.cs            # 背包管理
│   ├── minigames/                   # 小游戏脚本
│   │   ├── AlchemyController.cs    # 炼丹控制器
│   │   ├── FishingController.cs    # 钓鱼控制器
│   │   └── PuzzleController.cs     # 解谜控制器
│   ├── ui/                          # UI脚本
│   │   ├── MenuController.cs       # 菜单控制
│   │   ├── InventoryUI.cs          # 背包UI
│   │   ├── DialogueSystem.cs       # 对话系统
│   │   └── HUD.cs                  # 游戏界面
│   └── utils/                       # 工具脚本
│       ├── Constants.cs            # 常量定义
│       ├── Utils.cs                # 工具函数
│       └── DataStructures.cs       # 数据结构
├── assets/                          # 资源文件目录
│   ├── sprites/                     # 精灵图片
│   │   ├── characters/             # 角色贴图
│   │   ├── items/                  # 物品图标
│   │   ├── ui/                     # UI图标
│   │   └── effects/                # 特效贴图
│   ├── textures/                    # 纹理文件
│   │   ├── backgrounds/            # 背景纹理
│   │   └── tilesets/               # 瓦片集
│   ├── audio/                       # 音频文件
│   │   ├── music/                  # 背景音乐
│   │   ├── sfx/                    # 音效
│   │   └── voice/                  # 语音
│   ├── fonts/                       # 字体文件
│   ├── animations/                  # 动画文件
│   └── data/                        # 数据文件
│       ├── player_data.json        # 玩家数据模板
│       ├── items_config.json       # 物品配置
│       ├── skills_config.json      # 技能配置
│       └── dialogue_data.json      # 对话数据
└── docs/                            # 文档目录
    ├── README.md                    # 项目说明
    ├── API.md                       # API文档
    └── CHANGELOG.md                 # 更新日志
```

## 核心模块说明

### 1. 核心系统 (core/)
负责游戏的基础框架和全局管理
- **GameManager**: 游戏状态管理、场景切换、全局事件处理
- **SaveManager**: 存档系统，负责玩家数据的保存和读取
- **AudioManager**: 音频管理，包括背景音乐和音效控制
- **EventBus**: 事件总线，实现模块间的松耦合通信

### 2. 角色系统 (characters/)
处理所有角色相关功能
- **Player**: 玩家角色控制，包括移动、交互、动画
- **PlayerStats**: 玩家属性管理，如生命值、法力值、境界等
- **NPCController**: NPC行为控制，对话、任务分发等
- **EnemyAI**: 敌人AI逻辑，战斗行为模式

### 3. 地图系统 (maps/)
负责游戏世界的构建和导航
- **WorldMapController**: 大地图控制，玩家在世界中的移动
- **MapGenerator**: 程序化地图生成（如随机副本）
- **TeleportPoint**: 传送点系统，快速旅行功能

### 4. 战斗系统 (battle/)
回合制或即时战斗的核心逻辑
- **BattleSystem**: 战斗流程控制，技能释放、伤害计算
- **Skill**: 技能基类，定义所有技能的通用属性和行为
- **CombatCalculator**: 战斗数值计算，伤害、命中、暴击等
- **TurnManager**: 回合管理，行动顺序、时间控制

### 5. 修炼系统 (cultivation/)
修仙游戏特色功能
- **CultivationManager**: 修炼进度管理，经验获取、境界提升
- **Realm**: 境界系统，不同修炼阶段的属性加成
- **Technique**: 功法系统，技能学习和升级

### 6. 物品系统 (items/)
游戏内物品和装备管理
- **Item**: 物品基类，定义所有物品的基础属性
- **Equipment**: 装备类，武器、防具等可穿戴物品
- **Consumable**: 消耗品类，药品、符箓等一次性物品
- **Inventory**: 背包管理，物品存储、排序、使用

### 7. 小游戏系统 (minigames/)
丰富游戏体验的休闲内容
- **AlchemyController**: 炼丹小游戏，材料配比、成功率计算
- **FishingController**: 钓鱼小游戏，技巧操作、鱼类收集
- **PuzzleController**: 解谜小游戏，机关破解、智力挑战

### 8. UI系统 (ui/)
用户界面和交互体验
- **MenuController**: 主菜单控制，游戏启动、设置、存档选择
- **InventoryUI**: 背包界面，物品展示、分类、操作
- **DialogueSystem**: 对话系统，NPC交互、剧情展示
- **HUD**: 游戏界面，血条、法力条、小地图等实时信息

### 9. 工具系统 (utils/)
通用功能和辅助工具
- **Constants**: 游戏常量定义，数值配置、字符串常量
- **Utils**: 工具函数集合，数学计算、字符串处理等
- **DataStructures**: 自定义数据结构，队列、栈、树等

## 开发规范

### 文件命名规范
- **场景文件**: PascalCase + .tscn (如: PlayerCharacter.tscn)
- **脚本文件**: PascalCase + .cs (如: PlayerController.cs)
- **资源文件**: snake_case (如: player_idle_01.png)
- **配置文件**: snake_case + .json (如: items_config.json)

### 代码命名规范
- **类名**: PascalCase (如: PlayerController, BattleSystem)
- **函数名**: PascalCase (如: MovePlayer(), CalculateDamage())
- **变量名**: camelCase (如: playerHealth, maxMana)
- **常量**: PascalCase + 前缀 (如: MaxLevel, DefaultSpeed)
- **事件**: PascalCase + EventHandler后缀 (如: HealthChangedEventHandler)
- **枚举**: PascalCase (如: CharacterState.Idle)
- **接口**: PascalCase + I前缀 (如: IPlayerController)
- **私有字段**: camelCase + _前缀 (如: _playerHealth)

### 代码结构规范
```csharp
using Godot;
using System;

namespace XiuxianDemo
{
    public partial class ClassName : BaseClass
    {
        // 信号定义（使用C#事件）
        [Signal]
        public delegate void SignalNameHandler(Type param);
        
        // 枚举定义
        public enum StateType
        {
            Idle,
            Moving,
            Attacking
        }
        
        // 常量定义
        public const int MaxValue = 100;
        
        // 导出变量（使用[Export]特性）
        [Export]
        public float ExportedVariable { get; set; } = 1.0f;
        
        // 公共变量
        public string PublicVariable { get; set; }
        
        // 私有变量
        private bool _privateVariable;
        
        // 生命周期函数
        public override void _Ready()
        {
            base._Ready();
        }
        
        public override void _Process(double delta)
        {
            base._Process(delta);
        }
        
        // 公共函数
        public void PublicFunction()
        {
            // Implementation
        }
        
        // 私有函数
        private void PrivateFunction()
        {
            // Implementation
        }
    }
}
```

### 模块间通信规范
- **优先使用EventBus**: 模块间通过事件总线进行通信
- **避免直接引用**: 不要直接引用其他模块的具体实现
- **使用C#事件**: 场景间通过C#事件传递消息
- **使用接口**: 通过接口定义模块间交互契约
- **依赖注入**: 使用Godot的节点系统实现依赖注入

### 注释规范
- **类注释**: 说明类的功能和用途
- **函数注释**: 说明参数、返回值和主要逻辑
- **复杂逻辑**: 在关键算法处添加详细注释
- **TODO标记**: 使用# TODO: 标记待完成功能

### 错误处理规范
- **参数验证**: 对外部输入进行有效性检查，使用ArgumentException
- **异常捕获**: 使用try-catch块处理异常
- **日志记录**: 使用GD.PrintErr()和GD.Print()记录日志
- **空值检查**: 使用null条件运算符和空值合并运算符
- **异常类型**: 定义自定义异常类用于游戏特定错误

### 代码组织规范
1. 每个模块的开发应遵循此结构
2. 模块间的接口应尽量清晰，减少耦合
3. 代码应有适当的注释，便于理解和维护
4. 每个模块开发完成后，应进行单元测试

## 模块管理

### 版本控制
- 使用Git进行版本管理
- 每个功能模块使用独立分支开发
- 定期合并到主分支并进行集成测试
- 重要版本打tag标记

### 依赖关系
- **核心模块**: 被所有其他模块依赖
- **独立模块**: 小游戏、特效等可独立运行
- **耦合模块**: 战斗、修炼等需要协同工作

### 模块优先级
1. **高优先级**: 核心系统、角色系统、地图系统
2. **中优先级**: 战斗系统、物品系统、UI系统
3. **低优先级**: 修炼系统、小游戏系统、特效系统

## 快速定位和修改指南

### 按功能查找文件
```
角色移动问题 → scripts/characters/Player.cs
地图加载问题 → scripts/maps/WorldMapController.cs
战斗逻辑问题 → scripts/battle/BattleSystem.cs
界面显示问题 → scripts/ui/对应UI控制器
音效播放问题 → scripts/core/AudioManager.cs
存档读取问题 → scripts/core/SaveManager.cs
```

### 按类型查找文件
```
添加新场景 → scenes/对应模块目录/
修改角色属性 → data/characters_data.json
调整游戏数值 → scripts/utils/Constants.gd
更换贴图资源 → assets/textures/对应目录/
修改音效 → assets/sounds/对应目录/
```

### 模块间关系图
```
核心系统 (core/)
    ├── 为所有模块提供基础服务
    └── EventBus连接各模块通信

角色系统 (characters/)
    ├── 依赖：核心系统
    └── 被依赖：地图、战斗、UI系统

地图系统 (maps/)
    ├── 依赖：核心系统、角色系统
    └── 被依赖：战斗系统（战斗场景）

战斗系统 (battle/)
    ├── 依赖：角色、物品、核心系统
    └── 相对独立，通过EventBus通信

其他模块
    └── 大多依赖核心系统，相互独立
```

## 开发流程建议

### 第一阶段：基础框架
1. **搭建核心系统**
   - 创建EventBus事件总线
   - 实现GameManager基础框架
   - 设置AudioManager和SaveManager骨架

2. **建立基础角色系统**
   - 创建Player基础控制
   - 实现基本移动和动画
   - 设置PlayerStats数据结构

3. **构建简单地图**
   - 创建基础大地图场景
   - 实现角色在地图中移动
   - 测试场景切换功能

### 第二阶段：核心功能
1. **完善战斗系统**
   - 实现基础战斗流程
   - 创建技能系统框架
   - 添加简单的AI逻辑

2. **扩展物品系统**
   - 创建物品基类和子类
   - 实现背包管理
   - 添加装备功能

3. **建设UI系统**
   - 创建主要游戏界面
   - 实现菜单和对话系统
   - 完善交互体验

### 第三阶段：特色功能
1. **修炼系统**
   - 设计境界等级
   - 实现修炼进度
   - 添加功法系统

2. **小游戏模块**
   - 按优先级逐个实现
   - 独立测试各小游戏
   - 集成到主游戏流程

### 测试和优化
- 每个阶段完成后进行集成测试
- 性能监控和优化
- Bug修复和代码重构

## 维护和扩展

### 添加新模块
1. 在对应目录创建文件夹
2. 按照命名规范创建文件
3. 实现模块接口
4. 在EventBus中注册相关事件
5. 更新此文档说明

### 修改现有功能
1. 根据功能定位到对应文件
2. 检查模块依赖关系
3. 进行修改并测试
4. 更新相关文档

---

**注意**: 此文档应随项目发展不断更新，确保与实际代码结构保持一致。在重大结构调整时，务必同步更新此文档。