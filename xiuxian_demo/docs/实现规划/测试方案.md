# 修仙Demo项目测试方案

## 一、单元测试部分

### 1. 单元测试概述
单元测试是软件开发中的一种测试方法，用于验证单个代码单元（如类、方法）的功能是否符合预期。在Godot C#项目中，我们使用GdUnit4框架进行单元测试。

### 2. GdUnit4框架介绍
GdUnit4是一个专为Godot引擎设计的测试框架，支持GDScript和C#。通过GdUnit4，我们可以：

**关键点2**：对于C#测试，需要在GdUnit4CSharpApi.cs的DiscoverTests方法中为返回的测试用例字典添加suite_resource_path字段，其值应与source_file相同，这是官方文档未提及但实际必须的配置。
- 编写和运行单元测试
- 使用断言验证代码行为
- 集成到CI/CD流程
- 在Godot编辑器或外部IDE中运行测试

### 3. 项目配置
#### 3.1 主项目配置
确保`xiuxian_demo.csproj`文件中包含以下配置：

**关键点1**：必须添加`<DefineConstants>GDUNIT4NET_API_V5</DefineConstants>`定义常量，这是GdUnit4 C#测试能正常运行的关键配置。
```xml
<Project Sdk="Godot.NET.Sdk/4.4.1">
  <PropertyGroup>
    <TargetFrameworks>net8.0</TargetFrameworks>
    <LangVersion>12.0</LangVersion>
    <Nullable>enable</Nullable>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
    <NoWarn>NU1605</NoWarn>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.14.1" />
    <PackageReference Include="gdUnit4.api" Version="5.0.0" />
    <PackageReference Include="gdUnit4.test.adapter" Version="3.0.0" />
    <PackageReference Include="gdUnit4.analyzers" Version="1.0.0">
      <PrivateAssets>none</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>
</Project>
```

#### 3.2 测试项目配置
确保测试项目文件中包含以下配置：
```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <LangVersion>12.0</LangVersion>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.14.1" />
    <PackageReference Include="gdUnit4.api" Version="5.0.0" />
    <PackageReference Include="gdUnit4.test.adapter" Version="3.0.0" />
    <PackageReference Include="gdUnit4.analyzers" Version="1.0.0">
      <PrivateAssets>none</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\..\xiuxian_demo.csproj" />
  </ItemGroup>
</Project>
```

### 4. 编写单元测试
#### 4.1 测试类结构
创建测试类时，需要：
- 添加`[TestSuite]`属性
- 使用`[BeforeTest]`特性标记初始化方法
- 使用`[TestCase]`特性标记测试方法

示例：
```csharp
using GdUnit4;
using static GdUnit4.Assertions;
using Godot;

namespace XiuxianDemo.Tests.Characters
{
    [TestSuite]
    public class CharacterLevelGdUnitTest
    {
        private CharacterLevel _characterLevel;

        [BeforeTest]
        public void Setup()
        {
            _characterLevel = new CharacterLevel();
        }

        [TestCase]
        public void TestInitialLevel()
        {
            // 测试初始等级是否为1
            AssertThat(_characterLevel.Level).IsEqual(1);
        }

        // 更多测试方法...
    }
}
```

#### 4.2 断言方法
GdUnit4提供了丰富的断言方法，常用的有：
- `AssertThat(actual).IsEqual(expected)`: 验证两个值相等
- `AssertThat(actual).IsNotEqual(expected)`: 验证两个值不相等
- `AssertThat(actual).IsGreaterThan(expected)`: 验证实际值大于预期值
- `AssertThat(actual).IsLessThan(expected)`: 验证实际值小于预期值
- `AssertThat(actual).IsNull()`: 验证对象为null
- `AssertThat(actual).IsNotNull()`: 验证对象不为null
- `AssertThat(actual).IsTrue()`: 验证条件为true
- `AssertThat(actual).IsFalse()`: 验证条件为false

### 5. 运行测试
#### 5.1 在Godot编辑器中运行
1. 确保已安装GdUnit4插件
2. 打开Godot编辑器，导航到`Project > Tools > GdUnit4 > Test Runner`
3. 在测试运行器窗口中选择要运行的测试，点击"Run Selected Tests"

#### 5.2 在外部IDE中运行
- **Visual Studio**: 打开测试资源管理器，选择要运行的测试
- **JetBrains Rider**: 使用内置的测试运行功能
- **Visual Studio Code**: 安装C#扩展，使用测试面板运行测试

### 6. 测试最佳实践
1. **测试单一职责**：每个测试方法应只测试一个功能点
2. **使用有意义的测试名称**：清晰描述测试的功能和预期结果
3. **保持测试独立**：测试之间不应相互依赖
4. **测试边界条件**：如最大值、最小值、空值等
5. **定期运行测试**：确保代码变更不会破坏现有功能
6. **测试覆盖率**：争取高覆盖率，但不要为了覆盖率而测试

### 7. 示例测试用例
以`CharacterLevel`类为例，以下是一些测试用例：
1. 测试初始等级是否为1
2. 测试升级所需经验值计算
3. 测试添加经验值是否正确升级
4. 测试等级上限
5. 测试降级功能（如果有）