# 一期模块通信规范

## 概述
本文件定义了游戏一期（MVP版本）各模块间的通信机制，包括事件总线消息格式和模块接口直接调用规范。规范的目的是确保模块间交互清晰、可扩展，并减少耦合。

## 通信机制
一期采用两种主要通信方式：
1. **事件总线**：基于发布/订阅模式的异步通信，适用于非紧急、跨模块的状态通知
2. **直接接口调用**：同步通信，适用于需要立即获取结果的场景

## 事件总线消息格式
所有事件消息遵循以下通用格式：
```csharp
public class EventMessage
{
    public string EventName { get; set; }         // 事件名称
    public object Sender { get; set; }           // 发送者
    public Dictionary<string, object> Data { get; set; } // 事件数据
    public float Timestamp { get; set; }         // 时间戳
}
```

## 核心模块通信规范

### 1. 角色属性系统
#### 事件总线消息
- **属性变更事件**
  - 事件名称: `OnAttributeChanged`
  - 触发条件: 角色任何属性发生变更时
  - 数据格式: 
    ```csharp
    {
        "AttributeId": string,      // 属性ID
        "OldValue": object,         // 旧值
        "NewValue": object,         // 新值
        "AttributeType": AttributeType // 属性类型
    }
    ```

- **等级提升事件**
  - 事件名称: `OnLevelUp`
  - 触发条件: 角色升级时
  - 数据格式: 
    ```csharp
    {
        "OldLevel": int,            // 旧等级
        "NewLevel": int,            // 新等级
        "NewAttributes": Dictionary<string, object> // 新属性
    }
    ```

#### 直接接口调用
- **获取属性值**
  - 接口: `IAttributeManager.GetAttribute(string attributeId, AttributeType type)`
  - 参数: 
    - `attributeId`: 属性唯一标识
    - `type`: 属性类型
  - 返回值: `float` - 属性值
  - 调用场景: 任何模块需要获取角色属性时

- **设置属性值**
  - 接口: `IAttributeManager.SetAttribute(string attributeId, object value, AttributeType type)`
  - 参数: 
    - `attributeId`: 属性唯一标识
    - `value`: 新属性值
    - `type`: 属性类型
  - 返回值: `void`
  - 调用场景: 物品、技能等系统需要修改角色属性时

### 2. 战斗系统
#### 事件总线消息
- **战斗开始事件**
  - 事件名称: `OnBattleStarted`
  - 触发条件: 战斗开始时
  - 数据格式: 
    ```csharp
    {
        "BattleId": string,         // 战斗ID
        "Participants": List<BattleParticipant> // 参与者列表
    }
    ```

- **战斗结束事件**
  - 事件名称: `OnBattleEnded`
  - 触发条件: 战斗结束时
  - 数据格式: 
    ```csharp
    {
        "BattleId": string,         // 战斗ID
        "IsPlayerVictory": bool,    // 是否玩家胜利
        "ExperienceGained": float,  // 获得经验
        "LootItems": List<ItemBase> // 战利品
    }
    ```

- **技能释放事件**
  - 事件名称: `OnSkillCast`
  - 触发条件: 释放技能时
  - 数据格式: 
    ```csharp
    {
        "CasterId": string,         // 施法者ID
        "SkillId": string,          // 技能ID
        "TargetIds": List<string>,  // 目标ID列表
        "SkillEffects": List<SkillEffect> // 技能效果
    }
    ```

#### 直接接口调用
- **获取战斗状态**
  - 接口: `BattleManager.GetCurrentState()`
  - 参数: 无
  - 返回值: `CombatState` - 当前战斗状态
  - 调用场景: UI系统需要显示战斗状态时

- **处理输入**
  - 接口: `BattleManager.HandleInput(InputEvent input)`
  - 参数: 
    - `input`: 输入事件
  - 返回值: `void`
  - 调用场景: 玩家进行战斗操作时

### 3. 物品与背包系统
#### 事件总线消息
- **物品添加事件**
  - 事件名称: `OnItemAdded`
  - 触发条件: 物品添加到背包时
  - 数据格式: 
    ```csharp
    {
        "ItemId": string,           // 物品ID
        "Count": int,               // 物品数量
        "InventorySlot": int        // 槽位索引
    }
    ```

- **物品使用事件**
  - 事件名称: `OnItemUsed`
  - 触发条件: 使用物品时
  - 数据格式: 
    ```csharp
    {
        "ItemId": string,           // 物品ID
        "CountUsed": int,           // 使用数量
        "EffectApplied": bool       // 是否成功应用效果
    }
    ```

#### 直接接口调用
- **添加物品**
  - 接口: `Inventory.AddItem(ItemBase item, int count)`
  - 参数: 
    - `item`: 物品实例
    - `count`: 物品数量
  - 返回值: `bool` - 是否添加成功
  - 调用场景: 战斗、任务等系统奖励物品时

- **使用物品**
  - 接口: `Inventory.UseItem(string itemId, IAttributeManager attributeManager)`
  - 参数: 
    - `itemId`: 物品ID
    - `attributeManager`: 属性管理器接口
  - 返回值: `bool` - 是否使用成功
  - 调用场景: 玩家使用物品时

### 4. UI系统
#### 事件总线消息
- **面板显示事件**
  - 事件名称: `OnPanelShown`
  - 触发条件: 面板显示时
  - 数据格式: 
    ```csharp
    {
        "PanelId": string,          // 面板ID
        "Layer": UILayer            // 面板层级
    }
    ```

- **面板隐藏事件**
  - 事件名称: `OnPanelHidden`
  - 触发条件: 面板隐藏时
  - 数据格式: 
    ```csharp
    {
        "PanelId": string           // 面板ID
    }
    ```

- **元素更新事件**
  - 事件名称: `OnElementUpdated`
  - 触发条件: UI元素更新时
  - 数据格式: 
    ```csharp
    {
        "ElementId": string,        // 元素ID
        "PanelId": string,          // 面板ID
        "NewValue": object          // 新值
    }
    ```

#### 直接接口调用
- **显示面板**
  - 接口: `IUIManager.ShowPanel(string panelId)`
  - 参数: 
    - `panelId`: 面板ID
  - 返回值: `void`
  - 调用场景: 任何系统需要显示UI面板时

- **隐藏面板**
  - 接口: `IUIManager.HidePanel(string panelId)`
  - 参数: 
    - `panelId`: 面板ID
  - 返回值: `void`
  - 调用场景: 任何系统需要隐藏UI面板时

- **更新面板数据**
  - 接口: `IUIManager.UpdatePanelData(string panelId, params object[] data)`
  - 参数: 
    - `panelId`: 面板ID
    - `data`: 更新数据
  - 返回值: `void`
  - 调用场景: 任何系统需要更新UI数据时

### 5. 事件总线
#### 接口调用
- **发布事件**
  - 接口: `IEventBus.Publish(string eventName, params object[] args)`
  - 参数: 
    - `eventName`: 事件名称
    - `args`: 事件参数
  - 返回值: `void`
  - 调用场景: 任何系统需要发布事件时

- **订阅事件**
  - 接口: `IEventBus.Subscribe(string eventName, Action handler)`
  - 参数: 
    - `eventName`: 事件名称
    - `handler`: 事件处理器
  - 返回值: `void`
  - 调用场景: 任何系统需要订阅事件时

- **取消订阅**
  - 接口: `IEventBus.Unsubscribe(string eventName, Action handler)`
  - 参数: 
    - `eventName`: 事件名称
    - `handler`: 事件处理器
  - 返回值: `void`
  - 调用场景: 任何系统需要取消订阅事件时

### 6. 地图与导航系统
#### 事件总线消息
- **地图加载事件**
  - 事件名称: `OnMapLoaded`
  - 触发条件: 地图加载完成时
  - 数据格式: 
    ```csharp
    {
        "MapId": string,           // 地图ID
        "MapName": string,         // 地图名称
        "MapType": MapType         // 地图类型
    }
    ```

- **地图卸载事件**
  - 事件名称: `OnMapUnloaded`
  - 触发条件: 地图卸载时
  - 数据格式: 
    ```csharp
    {
        "MapId": string           // 地图ID
    }
    ```

- **地图实体添加事件**
  - 事件名称: `OnMapEntityAdded`
  - 触发条件: 地图实体添加时
  - 数据格式: 
    ```csharp
    {
        "EntityId": string,        // 实体ID
        "EntityType": string,      // 实体类型
        "Position": Vector2        // 实体位置
    }
    ```

- **地图实体移除事件**
  - 事件名称: `OnMapEntityRemoved`
  - 触发条件: 地图实体移除时
  - 数据格式: 
    ```csharp
    {
        "EntityId": string         // 实体ID
    }
    ```

- **路径计算完成事件**
  - 事件名称: `OnPathCalculated`
  - 触发条件: 路径计算完成时
  - 数据格式: 
    ```csharp
    {
        "PathPoints": List<Vector2>, // 路径点列表
        "StartPoint": Vector2,       // 起点
        "EndPoint": Vector2          // 终点
    }
    ```

- **导航完成事件**
  - 事件名称: `OnNavigationComplete`
  - 触发条件: 到达导航目标时
  - 数据格式: 
    ```csharp
    {
        "TargetPoint": Vector2      // 目标点
    }
    ```

#### 直接接口调用
- **加载地图**
  - 接口: `IMapManager.LoadMap(string mapId)`
  - 参数: 
    - `mapId`: 地图ID
  - 返回值: `void`
  - 调用场景: 玩家切换地图时

- **获取当前地图**
  - 接口: `IMapManager.GetCurrentMap()`
  - 参数: 无
  - 返回值: `MapArea` - 当前地图区域
  - 调用场景: 任何系统需要获取当前地图信息时

- **寻找路径**
  - 接口: `IMapManager.FindPath(Vector2 start, Vector2 end)`
  - 参数: 
    - `start`: 起点坐标
    - `end`: 终点坐标
  - 返回值: `List<Vector2>` - 路径点列表
  - 调用场景: 导航系统或AI需要计算移动路径时

- **计算导航路径**
  - 接口: `IMapNavigation.CalculatePath(Vector2 start, Vector2 end)`
  - 参数: 
    - `start`: 起点坐标
    - `end`: 终点坐标
  - 返回值: `List<Vector2>` - 导航路径点列表
  - 调用场景: UI系统需要为玩家提供导航时

## 任务成就系统通信规范

### 3.1 事件总线消息

| 消息名称 | 发送方 | 接收方 | 数据格式 | 描述 |
|---------|-------|-------|---------|------|
| OnTaskAccepted | TaskSystem | UI系统 | `{ taskId: string, title: string, description: string }` | 当玩家接受任务时发送 |
| OnTaskCompleted | TaskSystem | UI系统 | `{ taskId: string, title: string }` | 当任务完成时发送 |
| OnRewardClaimed | TaskSystem | UI系统、物品与背包系统、角色属性系统 | `{ taskId: string, rewards: Array<{ type: string, itemId: string, quantity: number, experience: number, gold: number }> }` | 当领取任务奖励时发送 |
| OnAchievementUnlocked | AchievementSystem | UI系统 | `{ achievementId: string, title: string, description: string, type: string }` | 当成就解锁时发送 |
| OnAchievementRewardClaimed | AchievementSystem | UI系统、物品与背包系统、角色属性系统 | `{ achievementId: string, rewards: Array<{ type: string, itemId: string, quantity: number, experience: number, gold: number }> }` | 当领取成就奖励时发送 |

### 3.2 直接接口调用

| 调用方 | 被调用方 | 接口名称 | 参数 | 返回值 | 描述 |
|-------|---------|---------|------|-------|------|
| NPC系统 | TaskSystem | GetAvailableTasks | `{ attributeManager, inventory }` | `List<TaskBase>` | 获取玩家可接受的任务 |
| UI系统 | TaskSystem | AcceptTask | `{ taskId, attributeManager }` | `bool` | 接受任务 |
| 各系统 | TaskSystem | UpdateTaskProgress | `{ taskId, objectiveId, progress }` | `void` | 更新任务进度 |
| UI系统 | TaskSystem | ClaimReward | `{ taskId, attributeManager, inventory }` | `bool` | 领取任务奖励 |
| 游戏系统 | AchievementSystem | UpdateAchievementProgress | `{ achievementId, progress }` | `void` | 更新成就进度 |
| UI系统 | AchievementSystem | ClaimAchievementReward | `{ achievementId, attributeManager, inventory }` | `bool` | 领取成就奖励 |

## 存档系统通信规范

### 4.1 事件总线消息

| 消息名称 | 发送方 | 接收方 | 数据格式 | 描述 |
|---------|-------|-------|---------|------|
| OnSaveCompleted | SaveSystem | UI系统 | `{ success: boolean, message: string, slotId: number }` | 当保存游戏操作完成时发送 |
| OnLoadCompleted | SaveSystem | UI系统 | `{ success: boolean, message: string, slotId: number }` | 当加载游戏操作完成时发送 |
| OnSystemLoaded | 各系统 | SaveSystem | `{ systemName: string }` | 当各系统加载完成时发送给存档系统 |

### 4.2 直接接口调用

| 调用方 | 被调用方 | 接口名称 | 参数 | 返回值 | 描述 |
|-------|---------|---------|------|-------|------|
| UI系统 | SaveSystem | RequestSaveGame | `{ slotId: number, saveName: string }` | `void` | 请求保存游戏到指定存档槽 |
| UI系统 | SaveSystem | GetAllSaveSlots | `{}` | `SaveSlot[]` | 获取所有存档槽信息 |
| UI系统 | SaveSystem | LoadSave | `{ slotId: number }` | `void` | 请求加载指定存档 |
| UI系统 | SaveSystem | DeleteSave | `{ slotId: number }` | `bool` | 请求删除指定存档 |
| UI系统 | SaveSystem | RenameSave | `{ slotId: number, newName: string }` | `bool` | 请求重命名指定存档 |
| SaveSystem | 各系统 | CollectSaveData | `{}` | `CharacterData, InventoryData, AbilityData, MapData等` | 收集各系统的当前状态数据 |
| SaveSystem | 各系统 | ApplySaveData | `{ saveData: SaveData }` | `void` | 应用存档数据到各系统 |

## 核心成长系统通信规范

### 5.1 事件总线消息

| 消息名称 | 发送方 | 接收方 | 数据格式 | 描述 |
|---------|-------|-------|---------|------|
| OnAbsorbCompleted | AbsorbSystem | 角色属性系统、UI系统 | `{ isSuccess: boolean, absorbedAbility: { id: string, name: string, level: number }, experienceReward: number, message: string }` | 当吸收能力操作完成时发送 |
| OnAbilityUpgraded | GrowthSystem | 角色属性系统、UI系统 | `{ abilityId: string, name: string, newLevel: number, oldLevel: number }` | 当能力升级时发送 |

### 5.2 直接接口调用

| 调用方 | 被调用方 | 接口名称 | 参数 | 返回值 | 描述 |
|-------|---------|---------|------|-------|------|
| 战斗系统 | AbsorbSystem | TryAbsorb | `{ creatureId: string, character: Character }` | `AbsorbResult` | 尝试吸收妖兽能力 |
| AbsorbSystem | AbsorbSystem | CalculateSuccessRate | `{ creatureId: string, character: Character }` | `float` | 计算吸收成功率 |
| 角色属性系统 | GrowthSystem | AddAbility | `{ character: Character, ability: AbilityBase }` | `bool` | 添加能力到角色 |
| 角色属性系统 | GrowthSystem | UpgradeAbility | `{ character: Character, abilityId: string }` | `bool` | 升级角色的指定能力 |
| 角色属性系统 | GrowthSystem | FuseAbilities | `{ character: Character, abilityIds: string[] }` | `bool` | 融合角色的多个能力 |
| AbsorbSystem | GrowthSystem | CreateAbility | `{ abilityId: string, level: number }` | `AbilityBase` | 创建能力实例 |

## 调试与监控系统通信规范

为提高多模块通信的可观测性和问题定位效率，特添加调试与监控系统。该系统提供日志记录、事件监控、性能统计和调试工具等功能，帮助开发者快速定位和解决模块间通信问题。

### 1. 核心功能
- **日志记录**：分级记录模块间通信事件、错误信息和调试数据
- **事件监控**：追踪事件总线消息的发布和订阅情况
- **性能统计**：收集接口调用性能数据，识别性能瓶颈
- **调试工具**：提供事件模拟、状态查询等调试功能

### 2. 事件总线消息

| 消息名称 | 发送方 | 接收方 | 数据格式 | 描述 |
|---------|-------|-------|---------|------|
| OnCommunicationLog | 各系统 | 调试与监控系统 | `{ level: LogLevel, module: string, message: string, data: object, timestamp: float }` | 记录通信日志 |
| OnEventPublished | 事件总线 | 调试与监控系统 | `{ eventName: string, sender: object, data: object, timestamp: float }` | 当事件被发布时发送 |
| OnEventReceived | 事件总线 | 调试与监控系统 | `{ eventName: string, receiver: object, data: object, timestamp: float }` | 当事件被接收时发送 |
| OnInterfaceCalled | 各系统 | 调试与监控系统 | `{ interfaceName: string, caller: object, params: object, timestamp: float }` | 当接口被调用时发送 |
| OnInterfaceReturned | 各系统 | 调试与监控系统 | `{ interfaceName: string, caller: object, result: object, executionTime: float, timestamp: float }` | 当接口返回时发送 |

### 3. 直接接口调用

| 调用方 | 被调用方 | 接口名称 | 参数 | 返回值 | 描述 |
|-------|---------|---------|------|-------|------|
| 开发者工具 | 调试与监控系统 | SetLogLevel | `{ level: LogLevel }` | `void` | 设置日志级别 |
| 开发者工具 | 调试与监控系统 | GetEventHistory | `{ eventName: string, startTime: float, endTime: float }` | `List<EventRecord>` | 获取事件历史记录 |
| 开发者工具 | 调试与监控系统 | GetInterfaceStats | `{ interfaceName: string, startTime: float, endTime: float }` | `InterfaceStats` | 获取接口调用统计 |
| 开发者工具 | 调试与监控系统 | SimulateEvent | `{ eventName: string, sender: object, data: object }` | `bool` | 模拟发送事件 |
| 开发者工具 | 调试与监控系统 | GetSubscribers | `{ eventName: string }` | `List<object>` | 获取事件订阅者 |
| 调试与监控系统 | 各系统 | RegisterDebugInfo | `{ systemName: string, info: object }` | `void` | 注册系统调试信息 |

### 4. 日志级别定义
```csharp
public enum LogLevel
{
    Debug,      // 调试信息
    Info,       // 一般信息
    Warning,    // 警告信息
    Error,      // 错误信息
    Critical    // 严重错误信息
}
```

### 5. 使用示例
#### 记录日志
```csharp
// 在战斗系统中记录技能释放日志
DebugMonitor.Log(LogLevel.Info, "BattleSystem", "Skill cast successfully", 
    new { CasterId = casterId, SkillId = skillId });
```

#### 监控接口性能
```csharp
// 在属性系统接口中添加性能监控
public float GetAttribute(string attributeId, AttributeType type)
{
    var startTime = Time.time;
    // 原有逻辑
    var value = _attributes[attributeId];
    // 记录性能数据
    DebugMonitor.RecordInterfaceCall("IAttributeManager.GetAttribute", this, 
        new { attributeId, type }, value, Time.time - startTime);
    return value;
}
```

## 其他模块通信规范

目前所有一期模块的通信规范已补充完成。