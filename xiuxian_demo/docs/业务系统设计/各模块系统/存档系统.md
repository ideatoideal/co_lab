# 存档系统

## 一、系统概述
存档系统是管理玩家游戏进度、支持多设备数据同步的核心系统。通过该系统，玩家可以在不同设备间无缝切换游戏，无需担心进度丢失。系统采用解耦设计，仅通过各系统提供的数据导出接口获取必要信息，不参与游戏逻辑，确保存档功能不影响核心玩法。

## 二、存档内容设计
### 2.1 核心存档数据
| 数据类别 | 具体内容 | 存储方式 |
|----------|----------|----------|
| 角色信息 | 境界、等级、经验值、属性点分配 | 结构化数据 |
| 属性数据 | 生命值、灵力值、体力值、攻击力、防御力等 | 结构化数据 |
| 背包物品 | 物品ID、数量、强化等级、异化效果 | 结构化数据 |
| 吞噬记录 | 已吞噬妖兽、灵草、法宝等目标记录 | 结构化数据 |
| 技能数据 | 已学习技能、技能等级、熟练度 | 结构化数据 |
| 装备数据 | 已装备物品、装备部位、强化等级 | 结构化数据 |
| 场景进度 | 当前所在场景、已探索区域、任务进度 | 结构化数据 |
| 系统设置 | 画面设置、音效设置、操作设置 | 结构化数据 |

### 2.2 数据格式示例
```json
{
  "playerInfo": {
    "level": 35,
    "realm": "金丹期",
    "experience": 15000,
    "attributePoints": 5
  },
  "attributes": {
    "health": 1200,
    "mana": 800,
    "stamina": 600,
    "attack": 350,
    "defense": 280
  },
  "inventory": [
    {"itemId": "herb_001", "quantity": 5, "level": 0},
    {"itemId": "sword_002", "quantity": 1, "level": 3, "specialEffect": "fire_damage"}
  ],
  "devourRecords": [
    {"targetId": "beast_015", "timestamp": 1623456789},
    {"targetId": "herb_023", "timestamp": 1623457890}
  ],
  "skills": [
    {"skillId": "fireball_001", "level": 2, "proficiency": 65}
  ],
  "equipment": {
    "head": {"itemId": "helmet_003", "level": 2},
    "body": {"itemId": "armor_005", "level": 1}
  },
  "sceneProgress": {
    "currentScene": "forest_002",
    "exploredAreas": ["forest_001", "cave_001"],
    "questProgress": {"main_quest_003": 75}
  },
  "settings": {
    "resolution": "1920x1080",
    "soundVolume": 80,
    "controlScheme": 1
  },
  "metadata": {
    "saveVersion": "1.0.0",
    "timestamp": 1623458901,
    "checksum": "a1b2c3d4e5f6"
  }
}
```

## 三、存档机制设计
### 3.1 本地存档
- 存储位置：Steam用户数据目录下的游戏专属文件夹
- 存储频率：
  - 自动保存：每30分钟自动保存一次
  - 手动保存：玩家可随时通过菜单手动保存
  - 触发保存：完成重要任务、境界突破、获取稀有物品时自动保存
- 存档数量：支持最多10个本地存档槽位

### 3.2 云端存档
- 存储位置：Steam Cloud云存储服务
- 同步机制：
  1. 游戏启动时自动下载最新云端存档
  2. 游戏退出时自动上传本地存档至云端
  3. 手动同步：玩家可通过菜单手动触发云端同步
- 冲突处理：
  - 以时间戳最新的存档为准
  - 若时间戳相同，优先保留本地存档
  - 同步前提示玩家，避免数据丢失

## 四、Steam平台集成
### 4.1 Steam云存档API集成
```csharp
// Steam云存档集成示例代码
public class SteamCloudService
{
    private readonly ISteamRemoteStorage _remoteStorage;

    public SteamCloudService()
    {
        _remoteStorage = SteamRemoteStorage();
    }

    // 上传存档到Steam云
    public bool UploadSaveToCloud(string saveData, string saveFileName)
    {
        if (!_remoteStorage.IsCloudEnabledForAccount() || !_remoteStorage.IsCloudEnabledForApp())
            return false;

        byte[] data = Encoding.UTF8.GetBytes(saveData);
        return _remoteStorage.FileWrite(saveFileName, data, data.Length);
    }

    // 从Steam云下载存档
    public string DownloadSaveFromCloud(string saveFileName)
    {
        if (!_remoteStorage.IsCloudEnabledForAccount() || !_remoteStorage.IsCloudEnabledForApp())
            return null;

        if (!_remoteStorage.FileExists(saveFileName))
            return null;

        byte[] data = new byte[_remoteStorage.GetFileSize(saveFileName)];
        if (_remoteStorage.FileRead(saveFileName, data, data.Length))
            return Encoding.UTF8.GetString(data);

        return null;
    }

    // 检查云端存档是否存在
    public bool DoesCloudSaveExist(string saveFileName)
    {
        return _remoteStorage.IsCloudEnabledForAccount() && 
               _remoteStorage.IsCloudEnabledForApp() && 
               _remoteStorage.FileExists(saveFileName);
    }
}
```

### 4.2 Steam用户认证
- 利用Steamworks API进行玩家身份认证
- 存档与Steam账号绑定，确保多设备访问安全性
- 遵守Steam平台的云存储政策和限制

## 五、解耦设计实现
### 5.1 数据导出接口
各系统需实现统一的数据导出接口，存档系统仅通过这些接口获取数据：
```csharp
public interface IDataExport
{
    // 导出系统数据
    Dictionary<string, object> ExportData();

    // 导入系统数据
    void ImportData(Dictionary<string, object> data);

    // 验证数据完整性
    bool ValidateData(Dictionary<string, object> data);
}
```

### 5.2 系统集成示例
```csharp
public class SaveSystem
{
    private Dictionary<string, IDataExport> _dataExporters;
    private SteamCloudService _steamCloudService;
    private EncryptionService _encryptionService;

    public SaveSystem()
    {
        _dataExporters = new Dictionary<string, IDataExport>();
        _steamCloudService = new SteamCloudService();
        _encryptionService = new EncryptionService();
    }

    // 注册数据导出器
    public void RegisterDataExporter(string systemName, IDataExport exporter)
    {
        if (!_dataExporters.ContainsKey(systemName))
            _dataExporters[systemName] = exporter;
    }

    // 创建存档
    public bool CreateSave(string saveName)
    {
        try
        {
            // 收集各系统数据
            Dictionary<string, object> saveData = new Dictionary<string, object>();
            foreach (var exporter in _dataExporters)
            {
                saveData[exporter.Key] = exporter.Value.ExportData();
            }

            // 添加元数据
            saveData["metadata"] = new Dictionary<string, object>
            {
                {"saveVersion", "1.0.0"},
                {"timestamp", DateTimeOffset.UtcNow.ToUnixTimeSeconds()},
                {"checksum", CalculateChecksum(saveData)}
            };

            // 加密数据
            string encryptedData = _encryptionService.Encrypt(JsonConvert.SerializeObject(saveData));

            // 保存到本地
            File.WriteAllText(Path.Combine(LocalSaveDirectory, $"{saveName}.sav"), encryptedData);

            // 同步到云端
            if (SteamManager.Initialized)
                _steamCloudService.UploadSaveToCloud(encryptedData, $"{saveName}.sav");

            return true;
        }
        catch (Exception e)
        {
            Debug.LogError($"Failed to create save: {e.Message}