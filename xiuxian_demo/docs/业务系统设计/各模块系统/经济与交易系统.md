# 经济与交易系统设计文档

## 一、系统概述
经济与交易系统是修仙世界中管理资源流通和物品交换的核心机制。通过建立完善的货币体系、商店系统和交易规则，为玩家提供合理的资源获取和消耗途径，维持游戏内的经济平衡。

### 设计目标
1. 建立稳定且灵活的货币体系
2. 提供多样化的物品获取和消耗途径
3. 实现动态的价格波动机制
4. 支持玩家与NPC之间的交易互动
5. 确保经济系统与其他系统的良好关联

## 二、货币体系
### 货币类型
| 货币类型 | 描述 | 获取途径 | 主要用途 |
|---------|-----|---------|---------|
| 灵石 | 基础货币，修仙世界通用 | 击杀妖兽、完成任务、采集灵矿 | 购买基础物品、修复装备、修炼 |
| 仙玉 | 高级货币，蕴含强大灵力 | 击败BOSS、完成特殊成就、充值 | 购买稀有道具、特殊服务、快速提升 |
| 门派贡献 | 门派内流通的特殊货币 | 完成门派任务、为门派做出贡献 | 兑换门派专属功法、装备、权限 |

### 货币转换机制
- 灵石与仙玉的兑换率为1000:1（可根据游戏经济状况动态调整）
- 门派贡献无法直接兑换为灵石或仙玉，但可通过特定NPC间接转化
- 货币转换需支付一定手续费（1%-5%）

## 三、商店系统
### 商店类型
| 商店类型 | 描述 | 刷新机制 | 特色 |
|---------|-----|---------|-----|
| 普通商店 | 出售基础物品和消耗品 | 每日刷新 | 价格固定，物品常见 |
| 特殊商店 | 出售稀有装备和功法 | 每周刷新或特定事件后刷新 | 价格较高，物品稀有 |
| 黑市 | 出售违禁品和稀有素材 | 随机刷新或特定条件触发 | 价格波动大，物品独特 |
| 门派商店 | 出售门派专属物品 | 每日刷新 | 只接受门派贡献兑换 |

### 商品价格机制
1. **基础价格**：根据物品 rarity、实用性和获取难度设定
2. **动态价格**：受玩家购买量、市场供需关系影响
   - 某类物品购买量增加，价格会上涨（最多上涨50%）
   - 某类物品长期无人购买，价格会下跌（最多下跌30%）
3. **折扣系统**：特定节日、玩家声望等级提升可获得折扣（最高50%）
4. **议价机制**：与部分NPC可进行议价，成功率受玩家魅力属性影响

### 商店库存管理
- 每种商品有固定库存，售完后需等待刷新
- 高级商品有购买数量限制（如每日1件）
- 特殊商店的库存受区域事件和玩家行为影响

## 四、交易流程
### 购买流程
1. 与NPC对话，打开商店界面
2. 浏览商品列表，查看价格和库存
3. 选择要购买的商品和数量
4. 确认交易，扣除相应货币
5. 物品自动添加到背包

### 出售流程
1. 与NPC对话，打开出售界面
2. 选择要出售的物品和数量
3. 系统根据物品价值自动计算出售价格（通常为购买价格的50%-80%）
4. 确认交易，获得相应货币
5. 物品从背包中移除

## 五、与其他系统的关联
### 事件驱动交互
1. **交易完成事件**：触发背包系统更新（物品增减）、角色属性系统更新（货币变化）
2. **价格波动事件**：触发商店系统更新（商品价格调整）
3. **库存刷新事件**：触发商店系统更新（商品库存重置）

### 数据交互接口
- IEconomicDataExport：经济数据导出接口
- IShopDataExport：商店数据导出接口
- IEventSystem：事件系统接口，用于发布和订阅经济相关事件

## 六、数据结构设计
### 货币数据结构
```csharp
public class CurrencyData
{
    public int SpiritStone;     // 灵石数量
    public int FairyJade;       // 仙玉数量
    public Dictionary<string, int> FactionContribution; // 各门派贡献
}
```

### 商品数据结构
```csharp
public class CommodityData
{
    public string Id;           // 商品ID
    public string Name;         // 商品名称
    public string Description;  // 商品描述
    public string ItemId;       // 对应物品ID
    public int BasePrice;       // 基础价格
    public int CurrentPrice;    // 当前价格
    public int Stock;           // 库存数量
    public int MaxStock;        // 最大库存
    public int DailyLimit;      // 每日购买限制
    public CommodityType Type;  // 商品类型
    public float RefreshRate;   // 刷新率
}
```

### 商店数据结构
```csharp
public class ShopData
{
    public string Id;           // 商店ID
    public string Name;         // 商店名称
    public string NPCId;        // 对应NPC ID
    public ShopType Type;       // 商店类型
    public List<CommodityData> Commodities; // 商品列表
    public int RefreshTime;     // 下次刷新时间（Unix时间戳）
    public float DiscountRate;  // 折扣率
}
```

## 七、界面设计
### 商店界面
- 商品列表：显示商品名称、图标、价格、库存和描述
- 分类筛选：按物品类型、价格区间等筛选商品
- 购买/出售切换：切换购买和出售模式
- 货币显示：显示当前拥有的各种货币数量
- 折扣提示：显示当前折扣信息和生效时间

### 交易确认界面
- 交易信息：显示购买/出售的物品、数量和总价格
- 确认按钮：确认交易
- 取消按钮：取消交易
- 货币不足提示：当货币不足时显示

## 八、性能优化策略
1. **数据缓存**：缓存商店和商品数据，减少数据库查询
2. **延迟加载**：仅在打开商店界面时加载相关数据
3. **批量更新**：批量处理价格波动和库存刷新
4. **异步处理**：异步加载商店数据，避免界面卡顿

## 九、未来拓展方向
1. **拍卖会系统**：定期举办拍卖会，玩家可竞拍稀有物品
2. **摆摊系统**：允许玩家在特定区域摆摊出售物品
3. **商会系统**：玩家可加入或创建商会，共同经营和管理
4. **经济调控系统**：通过NPC行为和事件调控游戏经济
5. **通货膨胀系统**：根据游戏内货币总量动态调整价格