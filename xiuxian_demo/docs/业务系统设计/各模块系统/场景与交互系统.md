# 场景与交互系统

## 一、系统概述
场景与交互系统是修仙世界的核心框架，负责管理游戏地图、场景物体交互及探索逻辑。通过该系统，玩家可以在不同修仙场景中探索、收集资源、完成任务，并与环境进行丰富互动。系统采用事件驱动的解耦设计，确保场景交互与其他系统（如吞噬、物品、任务系统）的灵活联动。

## 二、地图管理
### 2.1 场景类型与设计
| 场景类型       | 环境特点                  | 资源分布                | 危险程度 |
|----------------|---------------------------|-------------------------|----------|
| 灵脉森林       | 草木丰茂，灵气浓郁        | 灵草、低级妖兽、宝箱    | 低-中    |
| 废弃洞府       | 古老遗迹，机关重重        | 高阶装备、稀有材料、功法 | 中-高    |
| 修仙城镇       | 人类修士聚集地，安全区    | 商店、任务发布、交易    | 低       |
| 魔域边界       | 魔气弥漫，环境恶劣        | 魔核、异化材料          | 高       |
| 上古战场       | 残破遗址，灵气混乱        | 传承宝物、稀有矿石      | 极高     |

### 2.2 区域等级限制
- 场景区域划分为1-10级，对应不同境界妖兽/修士
- 低境界角色进入高等级区域会受到「威压」效果：属性降低50%，持续损失生命值
- 区域等级标识：通过地图界面颜色区分（白<绿<蓝<紫<橙<红）

### 2.3 地图加载机制
- 采用「无缝加载」技术，通过预加载相邻区域资源实现场景平滑切换
- 大型场景采用「分块加载」策略，根据玩家位置动态加载地图区块
- 场景切换触发事件：`EVENT_SCENE_CHANGED`，通知各系统更新状态

## 三、可交互物体系统
### 3.1 基础交互逻辑
- 交互触发方式：靠近物体按「F」键或点击（移动端）
- 交互距离：默认2米，可通过属性或技能扩展
- 交互优先级：任务相关物体 > 稀有资源 > 普通资源

### 3.2 宝箱系统
- 宝箱类型：木宝箱（普通）、铁宝箱（稀有）、金宝箱（史诗）、仙宝箱（传说）
- 奖励内容：进化材料、装备、灵石、功法残页
- 开启条件：部分高级宝箱需要对应钥匙或满足特定条件（如修为达到金丹期）
- 交互事件：`EVENT_CHEST_OPENED`，触发物品系统发放奖励

### 3.3 灵草系统
- 灵草等级：1-9级，对应不同年份（1年/10年/百年/千年/万年等）
- 交互方式：
  - 直接吞噬：获得灵气和随机属性加成
  - 采集：获得灵草材料，用于炼丹或合成
- 刷新机制：被采摘后，根据场景等级在24-72小时内随机刷新
- 交互事件：`EVENT_HERB_COLLECTED`/`EVENT_HERB_DEVOURED`，触发吞噬系统或任务系统判定

### 3.4 传送阵系统
- 功能：快速旅行到已解锁区域
- 解锁条件：
  1. 首次到达该区域
  2. 消耗特定物品（如「传送卷轴」）
  3. 完成区域解锁任务
- 使用消耗：每次传送消耗一定量灵石，距离越远消耗越多
- 交互事件：`EVENT_TELEPORT_USED`，触发场景加载机制

### 3.5 其他可交互物体
- 炼丹炉：用于炼制丹药
- 炼器台：用于打造和强化装备
- 任务公告板：领取区域任务
- 修炼蒲团：加速灵气吸收速度

## 四、解耦设计实现
### 4.1 事件总线机制
采用观察者模式实现事件通信，场景物体只负责触发事件，不关心事件如何处理。

```csharp
// 事件总线核心代码示例
public class EventBus
{
    private static Dictionary<string, List<Action<object[]>>> eventListeners = new Dictionary<string, List<Action<object[]>>>();

    public static void Subscribe(string eventName, Action<object[]> listener)
    {
        if (!eventListeners.ContainsKey(eventName))
            eventListeners[eventName] = new List<Action<object[]>>();
        eventListeners[eventName].Add(listener);
    }

    public static void Publish(string eventName, params object[] args)
    {
        if (eventListeners.TryGetValue(eventName, out var listeners))
        {
            foreach (var listener in listeners)
                listener(args);
        }
    }
}
```

### 4.2 系统间接口定义
场景系统提供以下接口供其他系统调用：
- `GetSceneInfo(sceneId)`: 获取场景信息
- `GetInteractiveObjectsInRange(position, radius)`: 获取范围内可交互物体
- `TriggerInteraction(objectId, playerId)`: 触发物体交互

其他系统通过事件监听与场景系统交互，无需直接依赖场景系统内部逻辑。

## 五、与其他系统关联
- **吞噬系统**：灵草吞噬交互触发属性加成判定
- **物品系统**：宝箱开启、采集资源触发物品发放
- **任务系统**：交互事件触发任务进度更新（如"吞噬10株千年灵草"）
- **战斗系统**：进入高等级区域触发威压效果，影响战斗属性
- **角色属性系统**：修为境界决定可进入的区域等级

## 六、未来拓展方向
1. **动态天气系统**：天气变化影响场景资源刷新和交互效果（如雨天灵草生长加速）
2. **昼夜循环系统**：昼夜交替改变场景危险度和资源分布
3. **场景破坏系统**：允许玩家破坏部分场景物体，获得稀有资源
4. **NPC交互优化**：增加更复杂的NPC交互选项和分支剧情
5. **多人协作探索**：支持组队探索，开启团队专属交互内容

通过以上设计，场景与交互系统将为玩家提供丰富多样的探索体验，同时保持与其他系统的高度解耦，确保游戏后期的扩展性和可维护性。