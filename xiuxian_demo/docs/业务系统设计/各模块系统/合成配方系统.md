# 合成配方系统

## 一、系统概述
合成配方系统是修仙世界中允许玩家将低级材料合成为高级材料、技能、装备的核心系统。通过该系统，玩家可以充分利用收集到的资源，打造更强大的物品和提升自身实力。系统采用独立设计，通过事件驱动与其他系统进行交互，确保功能完整性和系统间低耦合。

## 二、设计决策：独立系统 vs 拆分系统
### 2.1 方案对比
| 方案 | 优点 | 缺点 |
|------|------|------|
| 独立系统 | 1. 集中管理所有合成配方，维护成本低<br>2. 合成逻辑统一，便于扩展新类型合成<br>3. 与其他系统松耦合，改动不影响其他功能<br>4. 界面集成度高，用户体验一致 | 1. 系统初期开发工作量较大<br>2. 单一系统故障可能影响所有合成功能 |
| 拆分系统 | 1. 各系统负责各自合成逻辑，职责单一<br>2. 局部故障不影响整体 | 1. 配方分散管理，维护困难<br>2. 合成逻辑重复实现，代码冗余<br>3. 用户界面分散，体验不一致<br>4. 跨系统合成需求难以实现 |

### 2.2 最终选择
采用**独立系统设计**。独立系统能够更好地集中管理配方数据、统一合成逻辑，并通过事件总线机制与其他系统交互，既保证了功能的完整性，又维持了系统间的低耦合度。

## 三、核心功能设计
### 3.1 配方数据结构
```csharp
public class SynthesisRecipe
{
    public string RecipeId { get; set; }         // 配方ID
    public string Name { get; set; }             // 配方名称
    public string Description { get; set; }      // 配方描述
    public RecipeType Type { get; set; }         // 配方类型（材料/技能/装备）
    public List<RecipeIngredient> Ingredients { get; set; }  // 所需材料
    public List<RecipeProduct> Products { get; set; }        // 合成产物
    public float SuccessRate { get; set; }       // 基础成功率
    public int RequiredLevel { get; set; }       // 需求等级
    public string RequiredSkill { get; set; }    // 需求技能（可选）
    public Dictionary<string, object> Conditions { get; set; }  // 特殊条件
}

public enum RecipeType { Material, Skill, Equipment }

public class RecipeIngredient
{
    public string ItemId { get; set; }           // 物品ID
    public int Quantity { get; set; }            // 数量
    public bool IsConsumed { get; set; }         // 是否消耗
}

public class RecipeProduct
{
    public string ItemId { get; set; }           // 物品ID
    public int Quantity { get; set; }            // 数量
    public float DropRate { get; set; }          // 掉落概率
}
```

### 3.2 合成流程
1. **配方解锁**：通过任务、探索、购买等方式获得配方
2. **材料收集**：玩家收集合成所需的材料
3. **合成触发**：在特定界面或NPC处触发合成
4. **条件检查**：系统检查玩家等级、技能、材料等条件是否满足
5. **成功率判定**：根据基础成功率和各种加成计算最终成功率
6. **结果生成**：成功则生成产物，失败则可能损失部分或全部材料
7. **事件通知**：通过事件总线通知相关系统更新数据

### 3.3 成功率机制
- 基础成功率：配方固有的成功率
- 加成因素：
  - 角色技能等级加成
  - 特殊道具加成
  - 天气/时间加成
  - 幸运值加成
- 失败惩罚：
  - 普通失败：损失50%材料
  - 严重失败：损失全部材料
  - 暴击成功：获得双倍产物

## 四、界面设计
### 4.1 合成界面布局
1. **配方列表区**：显示所有已解锁配方，可按类型筛选
2. **材料需求区**：显示当前选中配方所需材料及玩家拥有数量
3. **产物预览区**：显示合成成功后的产物及概率
4. **合成控制区**：合成按钮、批量合成选项、成功率加成显示
5. **信息提示区**：显示合成结果、错误提示等信息

### 4.2 交互流程
- 点击配方列表中的配方，显示详细信息
- 材料不足时，高亮显示缺失材料
- 点击合成按钮，触发合成流程
- 合成过程中显示动画效果
- 合成完成后显示结果弹窗

## 五、与其他系统交互
### 5.1 事件驱动交互
通过事件总线机制实现与其他系统的交互：
- `EVENT_RECIPE_UNLOCKED`：配方解锁事件，通知UI系统更新配方列表
- `EVENT_SYNTHESIS_STARTED`：合成开始事件，通知日志系统记录
- `EVENT_SYNTHESIS_COMPLETED`：合成完成事件，通知物品系统更新背包
- `EVENT_SYNTHESIS_FAILED`：合成失败事件，通知物品系统扣除材料

### 5.2 系统集成
- **物品系统**：提供材料检查、物品增减功能
- **技能系统**：提供技能学习、技能等级查询功能
- **装备系统**：提供装备生成、强化功能
- **角色属性系统**：提供等级、幸运值等属性查询
- **任务系统**：触发配方解锁任务

## 六、配方示例
### 6.1 材料合成示例
| 配方名称 | 类型 | 所需材料 | 产物 | 成功率 | 需求 |
|----------|------|----------|------|--------|------|
| 聚气散 | 材料 | 灵草x3 + 铁矿石x2 | 聚气散x1 | 80% | 等级5 |
| 高级聚气散 | 材料 | 聚气散x2 + 百年灵草x1 | 高级聚气散x1 | 70% | 等级15 |
| 五行精华 | 材料 | 金之精x1 + 木之精x1 + 水之精x1 + 火之精x1 + 土之精x1 | 五行精华x1 | 60% | 等级30 |

### 6.2 技能合成示例
| 配方名称 | 类型 | 所需材料 | 产物 | 成功率 | 需求 |
|----------|------|----------|------|--------|------|
| 火球术 | 技能 | 火属性灵珠x1 + 技能残页x3 | 火球术技能书x1 | 75% | 等级10 |
| 高级火球术 | 技能 | 火球术技能书x1 + 高级火灵珠x1 + 天蚕丝x2 | 高级火球术技能书x1 | 65% | 等级25 |

### 6.3 装备合成示例
| 配方名称 | 类型 | 所需材料 | 产物 | 成功率 | 需求 |
|----------|------|----------|------|--------|------|
| 铁剑 | 装备 | 铁矿石x5 + 木材x3 | 铁剑x1 | 90% | 等级8 |
| 玄铁剑 | 装备 | 铁剑x1 + 玄铁x3 + 淬火液x2 | 玄铁剑x1 | 70% | 等级20 |
| 火龙剑 | 装备 | 玄铁剑x1 + 火龙晶x1 + 五行精华x1 | 火龙剑x1 | 50% | 等级40 |

## 七、未来拓展方向
1. **配方研究系统**：玩家可以通过研究现有配方，发现新配方
2. **合成套装效果**：特定装备组合合成时，触发额外属性加成
3. **跨玩家合成**：支持组队合成，提高成功率或获得特殊产物
4. **动态配方**：根据游戏内事件或季节变化，临时解锁特殊配方
5. **合成熟练度**：增加合成熟练度系统，熟练度越高，成功率越高
6. **失败产物系统**：失败时可能获得特殊的"失败产物"，可用于其他合成

通过以上设计，合成配方系统将为玩家提供丰富的资源利用和成长路径，同时保持与其他系统的高度解耦，确保游戏后期的扩展性和可维护性。