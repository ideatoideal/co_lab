# 炼丹炼器系统设计文档

## 一、系统概述
炼丹炼器系统是修仙世界中制作高级道具和装备的核心玩法。玩家通过收集材料、学习配方，炼制丹药提升属性，打造强力装备，增强自身实力。该系统强调策略性和随机性，为玩家提供丰富的成长路径。

### 设计目标
1. 提供多样化的丹药和装备制作途径
2. 实现材料收集与资源管理的深度玩法
3. 打造策略性与随机性并存的制作体验
4. 建立与角色成长、战斗系统的紧密关联
5. 支持系统的长期拓展与内容更新

## 二、炼丹系统
### 丹药分类
| 丹药等级 | 描述 | 示例 | 材料需求 |
|---------|-----|-----|---------|
| 凡品 | 基础丹药，效果较弱 | 回复丹、聚气丹 | 普通草药、矿物 |
| 良品 | 中级丹药，效果显著 | 小还丹、固元丹 | 稀有草药、妖兽内丹 |
| 上品 | 高级丹药，效果强大 | 大还丹、洗髓丹 | 珍奇草药、高阶妖兽内丹 |
| 极品 | 顶级丹药，效果逆天 | 九转还魂丹、破境丹 | 传说草药、神兽内丹 |

### 炼丹流程
1. **准备阶段**：
   - 收集所需药材（从采集、任务、战斗中获得）
   - 学习丹药配方（通过功法、NPC传授、探索获得）
   - 准备炼丹炉（不同品质的炼丹炉影响成功率）
2. **炼制阶段**：
   - 选择丹药配方
   - 放入所需药材
   - 控制火候（不同丹药需要不同火候控制）
   - 等待炼制完成
3. **结果阶段**：
   - 成功：获得丹药，可能出现高品质暴击
   - 失败：失去部分或全部材料
   - 大成功：获得多份丹药或特殊属性丹药

### 成功率机制
- 基础成功率 = 配方熟练度 + 炼丹炉品质加成 + 药材品质加成
- 熟练度：通过多次炼制同一丹药提升
- 炼丹炉品质：凡品(+0%)、良品(+10%)、上品(+20%)、极品(+30%)
- 药材品质：普通(+0%)、优质(+5%)、完美(+15%)
- 失败惩罚：低阶丹药失败损失30%材料，高阶丹药失败损失50%-80%材料

### 丹药效果示例
- 回复丹：立即回复100点生命值
- 聚气丹：提升10%灵力恢复速度，持续30分钟
- 小还丹：瞬间恢复50%生命值和30%灵力
- 洗髓丹：永久提升角色1点根骨属性
- 破境丹：提升突破境界的成功率20%

## 三、炼器系统
### 装备分类
| 装备等级 | 描述 | 示例 | 材料需求 |
|---------|-----|-----|---------|
| 凡器 | 基础装备，属性一般 | 铁剑、布甲 | 普通矿石、皮革 |
| 灵器 | 中级装备，带有简单属性 | 青钢剑、玄铁护甲 | 稀有矿石、妖兽皮毛 |
| 宝器 | 高级装备，属性强大 | 龙泉剑、金刚甲 | 珍奇矿石、高阶妖兽材料 |
| 仙器 | 顶级装备，拥有特殊效果 | 斩妖剑、降魔甲 | 传说矿石、神兽材料 |

### 炼器流程
1. **准备阶段**：
   - 收集所需材料（矿石、皮革、妖兽材料等）
   - 学习炼器图纸（通过探索、任务、NPC传授获得）
   - 准备炼器炉（不同品质的炼器炉影响成功率和属性）
2. **打造阶段**：
   - 选择炼器图纸
   - 放入所需材料
   - 控制火候和捶打力度（不同装备需要不同操作）
   - 等待打造完成
3. **强化阶段**（可选）：
   - 使用强化石提升装备等级
   - 强化有失败风险，失败可能降低装备等级
   - 可使用保护符避免失败惩罚
4. **结果阶段**：
   - 成功：获得装备，可能出现高品质暴击
   - 失败：失去部分或全部材料
   - 大成功：获得带有额外属性的装备

### 成功率机制
- 基础成功率 = 图纸熟练度 + 炼器炉品质加成 + 材料品质加成
- 熟练度：通过多次打造同一装备提升
- 炼器炉品质：凡品(+0%)、良品(+10%)、上品(+20%)、极品(+30%)
- 材料品质：普通(+0%)、优质(+5%)、完美(+15%)
- 强化成功率：随强化等级提升而降低（1级100%，10级30%）

### 装备属性生成
- 基础属性：根据装备等级和类型固定生成
- 随机属性：每件装备随机生成1-3条额外属性
- 特殊效果：高阶装备可能带有特殊技能或被动效果
- 品质影响：高品质装备拥有更高的属性上限和更多的随机属性

## 四、与其他系统的关联
### 事件驱动交互
1. **炼制成功事件**：触发背包系统更新（物品添加）、成就系统更新（制作成就进度）
2. **炼制失败事件**：触发提示系统（失败提示）、日志系统（记录失败原因）
3. **装备强化事件**：触发装备系统更新（属性变化）、成就系统更新（强化成就进度）

### 数据交互接口
- IAlchemyDataExport：炼丹数据导出接口
- ISmithingDataExport：炼器数据导出接口
- IEventSystem：事件系统接口，用于发布和订阅炼丹炼器相关事件

## 五、数据结构设计
### 丹药配方数据结构
```csharp
public class AlchemyRecipe
{
    public string Id;           // 配方ID
    public string Name;         // 丹药名称
    public string Description;  // 丹药描述
    public int Level;           // 丹药等级
    public List<MaterialItem> Materials; // 所需材料
    public float BaseSuccessRate; // 基础成功率
    public string EffectId;     // 丹药效果ID
    public int MasteryRequired; // 所需熟练度
}
```

### 炼器图纸数据结构
```csharp
public class SmithingBlueprint
{
    public string Id;           // 图纸ID
    public string Name;         // 装备名称
    public string Description;  // 装备描述
    public int Level;           // 装备等级
    public EquipmentType Type;  // 装备类型
    public List<MaterialItem> Materials; // 所需材料
    public float BaseSuccessRate; // 基础成功率
    public List<AttributeRange> BaseAttributes; // 基础属性范围
    public int MaxRandomAttributes; // 最大随机属性数量
    public int MasteryRequired; // 所需熟练度
}
```

### 材料数据结构
```csharp
public class MaterialItem
{
    public string ItemId;       // 物品ID
    public int Quantity;        // 数量
    public int Quality;         // 品质(1-3:普通-优质-完美)
}
```

## 六、界面设计
### 炼丹界面
- 配方选择：显示已学习的丹药配方
- 材料栏：显示所需材料和当前拥有数量
- 炼丹炉：显示当前使用的炼丹炉品质和加成
- 成功率：显示当前炼制的成功率
- 火候控制：滑动条或按钮控制火候
- 炼制按钮：开始炼制

### 炼器界面
- 图纸选择：显示已学习的炼器图纸
- 材料栏：显示所需材料和当前拥有数量
- 炼器炉：显示当前使用的炼器炉品质和加成
- 成功率：显示当前打造的成功率
- 强化界面：显示强化等级、成功率和所需材料
- 打造按钮：开始打造

## 七、性能优化策略
1. **数据缓存**：缓存配方和图纸数据，减少数据库查询
2. **延迟加载**：仅在打开炼丹/炼器界面时加载相关数据
3. **异步处理**：炼制和打造过程异步处理，避免界面卡顿
4. **资源池**：复用界面元素和效果，减少内存占用

## 八、未来拓展方向
1. **炼丹/炼器技能系统**：提升技能等级解锁更多高级配方
2. **套装系统**：打造特定套装获得额外属性加成
3. **宝石镶嵌系统**：为装备镶嵌宝石提升属性
4. **传承系统**：将旧装备的属性传承到新装备
5. **定制系统**：允许玩家自定义装备外观和部分属性